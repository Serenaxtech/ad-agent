<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" data-diagram-type="SEQUENCE" height="820px" preserveAspectRatio="none" style="width:814px;height:820px;background:#FFFFFF;" version="1.1" viewBox="0 0 814 820" width="814px" zoomAndPan="magnify"><title>Agent Authentication Flow</title><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="210.9092" x="298.0298" y="27.9951">Agent Authentication Flow</text><g><title>API Gateway</title><rect fill="#FFFFFF" height="491.1953" style="stroke:#181818;stroke-width:1;" width="10" x="460.1772" y="238.2578"/></g><rect fill="none" height="469.1953" style="stroke:#000000;stroke-width:1.5;" width="787.9688" x="10" y="253.2578"/><rect fill="none" height="362.6641" style="stroke:#000000;stroke-width:1.5;" width="767.9688" x="20" y="352.7891"/><rect fill="none" height="256.1328" style="stroke:#000000;stroke-width:1.5;" width="747.9688" x="30" y="452.3203"/><rect fill="none" height="149.6016" style="stroke:#000000;stroke-width:1.5;" width="654.4229" x="40" y="551.8516"/><g><title>Agent</title><rect fill="#000000" fill-opacity="0.00000" height="620.8594" width="8" x="69.7197" y="118.5938"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="73" x2="73" y1="118.5938" y2="739.4531"/></g><g><title>API Gateway</title><rect fill="#000000" fill-opacity="0.00000" height="620.8594" width="8" x="461.1772" y="118.5938"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="465.0229" x2="465.0229" y1="118.5938" y2="739.4531"/></g><g><title>Agent DB</title><rect fill="#000000" fill-opacity="0.00000" height="620.8594" width="8" x="644.2856" y="118.5938"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="648.1484" x2="648.1484" y1="118.5938" y2="739.4531"/></g><g><title>Token DB</title><rect fill="#000000" fill-opacity="0.00000" height="620.8594" width="8" x="727.1958" y="118.5938"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="730.4229" x2="730.4229" y1="118.5938" y2="739.4531"/></g><g class="participant participant-head" data-participant="Agent"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41.4395" x="50" y="115.292">Agent</text><ellipse cx="73.7197" cy="50.7969" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M73.7197,58.7969 L73.7197,85.7969 M60.7197,66.7969 L86.7197,66.7969 M73.7197,85.7969 L60.7197,100.7969 M73.7197,85.7969 L86.7197,100.7969" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-tail" data-participant="Agent"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41.4395" x="50" y="751.4482">Agent</text><ellipse cx="73.7197" cy="763.25" fill="#E2E2F0" rx="8" ry="8" style="stroke:#181818;stroke-width:0.5;"/><path d="M73.7197,771.25 L73.7197,798.25 M60.7197,779.25 L86.7197,779.25 M73.7197,798.25 L60.7197,813.25 M73.7197,798.25 L86.7197,813.25" fill="none" style="stroke:#181818;stroke-width:0.5;"/></g><g class="participant participant-head" data-participant="Middleware"><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="234.3086" x="348.0229" y="71"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="420.9556" y="90.9951">API Gateway</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="220.3086" x="355.0229" y="107.292">/authenticateAgent Middleware</text></g><g class="participant participant-tail" data-participant="Middleware"><rect fill="#E2E2F0" height="46.5938" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="234.3086" x="348.0229" y="738.4531"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="88.4434" x="420.9556" y="758.4482">API Gateway</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="220.3086" x="355.0229" y="774.7451">/authenticateAgent Middleware</text></g><g class="participant participant-head" data-participant="AgentDB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66.2744" x="612.1484" y="115.292">Agent DB</text><path d="M630.2856,66.2969 C630.2856,56.2969 648.2856,56.2969 648.2856,56.2969 C648.2856,56.2969 666.2856,56.2969 666.2856,66.2969 L666.2856,92.2969 C666.2856,102.2969 648.2856,102.2969 648.2856,102.2969 C648.2856,102.2969 630.2856,102.2969 630.2856,92.2969 L630.2856,66.2969" fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M630.2856,66.2969 C630.2856,76.2969 648.2856,76.2969 648.2856,76.2969 C648.2856,76.2969 666.2856,76.2969 666.2856,66.2969" fill="none" style="stroke:#181818;stroke-width:1.5;"/></g><g class="participant participant-tail" data-participant="AgentDB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="66.2744" x="612.1484" y="751.4482">Agent DB</text><path d="M630.2856,764.75 C630.2856,754.75 648.2856,754.75 648.2856,754.75 C648.2856,754.75 666.2856,754.75 666.2856,764.75 L666.2856,790.75 C666.2856,800.75 648.2856,800.75 648.2856,800.75 C648.2856,800.75 630.2856,800.75 630.2856,790.75 L630.2856,764.75" fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M630.2856,764.75 C630.2856,774.75 648.2856,774.75 648.2856,774.75 C648.2856,774.75 666.2856,774.75 666.2856,764.75" fill="none" style="stroke:#181818;stroke-width:1.5;"/></g><g class="participant participant-head" data-participant="TokenDB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.5459" x="694.4229" y="115.292">Token DB</text><path d="M713.1958,66.2969 C713.1958,56.2969 731.1958,56.2969 731.1958,56.2969 C731.1958,56.2969 749.1958,56.2969 749.1958,66.2969 L749.1958,92.2969 C749.1958,102.2969 731.1958,102.2969 731.1958,102.2969 C731.1958,102.2969 713.1958,102.2969 713.1958,92.2969 L713.1958,66.2969" fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M713.1958,66.2969 C713.1958,76.2969 731.1958,76.2969 731.1958,76.2969 C731.1958,76.2969 749.1958,76.2969 749.1958,66.2969" fill="none" style="stroke:#181818;stroke-width:1.5;"/></g><g class="participant participant-tail" data-participant="TokenDB"><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="67.5459" x="694.4229" y="751.4482">Token DB</text><path d="M713.1958,764.75 C713.1958,754.75 731.1958,754.75 731.1958,754.75 C731.1958,754.75 749.1958,754.75 749.1958,764.75 L749.1958,790.75 C749.1958,800.75 731.1958,800.75 731.1958,800.75 C731.1958,800.75 713.1958,800.75 713.1958,790.75 L713.1958,764.75" fill="#E2E2F0" style="stroke:#181818;stroke-width:1.5;"/><path d="M713.1958,764.75 C713.1958,774.75 731.1958,774.75 731.1958,774.75 C731.1958,774.75 749.1958,774.75 749.1958,764.75" fill="none" style="stroke:#181818;stroke-width:1.5;"/></g><g><title>API Gateway</title><rect fill="#FFFFFF" height="491.1953" style="stroke:#181818;stroke-width:1;" width="10" x="460.1772" y="238.2578"/></g><rect fill="#EEEEEE" height="3" style="stroke:#EEEEEE;stroke-width:1;" width="807.9688" x="0" y="149.1602"/><line style="stroke:#000000;stroke-width:1;" x1="0" x2="807.9688" y1="149.1602" y2="149.1602"/><line style="stroke:#000000;stroke-width:1;" x1="0" x2="807.9688" y1="152.1602" y2="152.1602"/><rect fill="#EEEEEE" height="23.1328" style="stroke:#000000;stroke-width:2;" width="289.2534" x="259.3577" y="138.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="270.7275" x="265.3577" y="154.6606">Agent Sends Authentication Request</text><g class="message" data-participant-1="Agent" data-participant-2="Middleware"><polygon fill="#181818" points="448.1772,234.2578,458.1772,238.2578,448.1772,242.2578,452.1772,238.2578" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="73.7197" x2="454.1772" y1="238.2578" y2="238.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121.2275" x="80.7197" y="187.7935">GET /api/v1/agent/</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58.4873" x="80.7197" y="202.9263">Headers:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="146.9165" x="80.7197" y="218.0591">x-agent-token: [token]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="97.0112" x="80.7197" y="233.1919">x-agent-id: [id]</text></g><path d="M10,253.2578 L74.4429,253.2578 L74.4429,260.3906 L64.4429,270.3906 L10,270.3906 L10,253.2578" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="469.1953" style="stroke:#000000;stroke-width:1.5;" width="787.9688" x="10" y="253.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="25" y="266.3247">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="111.1924" x="89.4429" y="265.4683">[Missing headers]</text><g class="message" data-participant-1="Middleware" data-participant-2="Agent"><polygon fill="#181818" points="84.7197,302.6563,74.7197,306.6563,84.7197,310.6563,80.7197,306.6563" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="78.7197" x2="459.1772" y1="306.6563" y2="306.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116.2256" x="90.7197" y="286.4575">401 Unauthorized</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="362.4575" x="90.7197" y="301.5903">{ error: "Agent token required and Agent Id required" }</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="10" x2="797.9688" y1="315.6563" y2="315.6563"/><g class="message" data-participant-1="Middleware" data-participant-2="AgentDB"><polygon fill="#181818" points="636.2856,333.7891,646.2856,337.7891,636.2856,341.7891,640.2856,337.7891" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="470.1772" x2="642.2856" y1="337.7891" y2="337.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143.1143" x="477.1772" y="332.7231">Find agent by agentId</text></g><path d="M20,352.7891 L84.4429,352.7891 L84.4429,359.9219 L74.4429,369.9219 L20,369.9219 L20,352.7891" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="362.6641" style="stroke:#000000;stroke-width:1.5;" width="767.9688" x="20" y="352.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="35" y="365.856">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="111.1763" x="99.4429" y="364.9995">[Agent not found]</text><g class="message" data-participant-1="Middleware" data-participant-2="Agent"><polygon fill="#181818" points="84.7197,402.1875,74.7197,406.1875,84.7197,410.1875,80.7197,406.1875" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="78.7197" x2="459.1772" y1="406.1875" y2="406.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116.2256" x="90.7197" y="385.9888">401 Unauthorized</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="182.5586" x="90.7197" y="401.1216">{ error: "Agent not found" }</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="20" x2="787.9688" y1="415.1875" y2="415.1875"/><g class="message" data-participant-1="Middleware" data-participant-2="TokenDB"><polygon fill="#181818" points="719.1958,433.3203,729.1958,437.3203,719.1958,441.3203,723.1958,437.3203" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="470.1772" x2="725.1958" y1="437.3203" y2="437.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="152.7881" x="477.1772" y="432.2544">Find token by agent._id</text></g><path d="M30,452.3203 L94.4429,452.3203 L94.4429,459.4531 L84.4429,469.4531 L30,469.4531 L30,452.3203" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="256.1328" style="stroke:#000000;stroke-width:1.5;" width="747.9688" x="30" y="452.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="45" y="465.3872">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="111.9067" x="109.4429" y="464.5308">[Token not found]</text><g class="message" data-participant-1="Middleware" data-participant-2="Agent"><polygon fill="#181818" points="84.7197,501.7188,74.7197,505.7188,84.7197,509.7188,80.7197,505.7188" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="78.7197" x2="459.1772" y1="505.7188" y2="505.7188"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116.2256" x="90.7197" y="485.52">401 Unauthorized</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="275.2852" x="90.7197" y="500.6528">{ error: "Token not found for this agent" }</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="30" x2="777.9688" y1="514.7188" y2="514.7188"/><g class="message" data-participant-1="Middleware" data-participant-2="TokenDB"><polygon fill="#181818" points="719.1958,532.8516,729.1958,536.8516,719.1958,540.8516,723.1958,536.8516" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="470.1772" x2="725.1958" y1="536.8516" y2="536.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209.6821" x="477.1772" y="531.7856">validateToken(agentAuthToken)</text></g><path d="M40,551.8516 L104.4429,551.8516 L104.4429,558.9844 L94.4429,568.9844 L40,568.9844 L40,551.8516" fill="#EEEEEE" style="stroke:#000000;stroke-width:1.5;"/><rect fill="none" height="149.6016" style="stroke:#000000;stroke-width:1.5;" width="654.4229" x="40" y="551.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="19.4429" x="55" y="564.9185">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="93.1616" x="119.4429" y="564.062">[Token invalid]</text><g class="message" data-participant-1="Middleware" data-participant-2="Agent"><polygon fill="#181818" points="84.7197,601.25,74.7197,605.25,84.7197,609.25,80.7197,605.25" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="78.7197" x2="459.1772" y1="605.25" y2="605.25"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116.2256" x="90.7197" y="585.0513">401 Unauthorized</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164.2646" x="90.7197" y="600.1841">{ error: "Invalid Token" }</text></g><line style="stroke:#000000;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="40" x2="694.4229" y1="614.25" y2="614.25"/><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="95.7075" x="45" y="624.4604">[Token is valid]</text><g class="message" data-participant-1="Middleware" data-participant-2="AgentDB"><polygon fill="#181818" points="636.2856,645.1875,646.2856,649.1875,636.2856,653.1875,640.2856,649.1875" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;" x1="470.1772" x2="642.2856" y1="649.1875" y2="649.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154.1084" x="477.1772" y="644.1216">Update agent.last_used</text></g><g class="message" data-participant-1="Middleware" data-participant-2="Agent"><polygon fill="#181818" points="84.7197,689.4531,74.7197,693.4531,84.7197,697.4531,80.7197,693.4531" style="stroke:#181818;stroke-width:1;"/><line style="stroke:#181818;stroke-width:1;stroke-dasharray:2.0,2.0;" x1="78.7197" x2="459.1772" y1="693.4531" y2="693.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47.7026" x="90.7197" y="673.2544">200 OK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="150.9473" x="90.7197" y="688.3872">{ authenticated: true }</text></g><!--SRC=[fPJRJW8n48Rl-nGJhlG25urNcs22mGCnHkFXIemPxIWJDrriktYAxsuF52eODKW2tSvC__d-jejbMn7q7aXPw3Lsv4Q-GykrWlsgVXO2xsojOu4OetPP7gChRlLE1t20bfxnTQWAdA-bg7RCKbOkgwa5QBAfa6Zn5WqvZL3PtmqLOTBVpT8NzIEfb0uJbnRTxfJtd9GqYzHdzDIGiT3j2X7BsZjPSoZXOEy22XnpCTaiq5SKGtL8A4cRSgXUsY7MjhvT2LTXl9x7MReWo-kmCpnnTdDh0Yllt1XM3p2AeWBS9oDeEw18Li9sPnCkbT-yMlCRoQ5w1zAwrcNQdD0Vj7F5cYIWajF50pcBjk13K6LegTDEsbJNQf_Tqk01Rb_Zmq265PuvQghQmdtTg1Z_5_TCoiDvfHdWCkJqQ1Daj9mWDsvuZkDHuwrOHbqHTq7E_Mgm8pQnUw9VSl2JYmbMx6unXSXQqF6tD4pNloZC_R0AgxvaLtGqY59HE3UGJAIM1dxlcL-Xox5tDJsM2eszQGpz6Nchqu6J8m-Q_rcurydgXXOfitDDptxqNo7fcrVl4m00]--></g></svg>